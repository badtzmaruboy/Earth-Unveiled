<!DOCTYPE html>
<html>
<head>
<style>
    /* Set the background color and font color */
    body {
        background-color: #1a1a1a; /* Dark background */
        color: #b0e0e6; /* Cool light blue font */
        font-family: Arial, sans-serif;
    }

    /* Style for buttons */
    button {
        background-color: #1e90ff; /* Dodger blue */
        color: #ffffff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
    }

    /* Change button color on hover */
    button:hover {
        background-color: #4682b4; /* Steel blue */
    }

    /* Style for the input fields */
    input[type="text"] {
        padding: 8px;
        border: 1px solid #4682b4;
        border-radius: 5px;
        color: #b0e0e6;
        background-color: #333333;
        font-size: 16px;
        width: 200px;
        margin: 5px;
    }

    /* Style for the result text */
    #demo, #opposedResult, #probabilityResult {
        margin-top: 20px;
        font-size: 18px;
        line-height: 1.5;
        color: #87cefa; /* Light sky blue */
    }
</style>
</head>

<body>

<h2>Dice Bot with +2 and Exploding Systems</h2>
<label for="diceInput1">Enter First Roll Command:</label>
<input type="text" id="diceInput1" placeholder="e.g., 7@6 Alpha" />
<br><br>

<label for="diceInput2">Enter Second Roll Command (for Opposed Rolls):</label>
<input type="text" id="diceInput2" placeholder="e.g., 5@7 Beta" />
<br><br>

<label for="system">Choose System:</label>
<select id="system">
    <option value="exploding">Exploding</option>
    <option value="+2">+2 for 10s</option>
</select>
<br><br>

<button type="button" onclick="regularRoll()">
Roll the Dice</button>
<button type="button" onclick="printMultipleRolls(10)">
Roll 10 Times</button>
<button type="button" onclick="opposedRoll()">
Opposed Roll</button>
<button type="button" onclick="toggleExactProbability()">
Exact Outcome Probability (Bell Curve)</button>
<button type="button" onclick="toggleCumulativeProbability()">
Cumulative Probability (Land on at least X)</button>

<p id="demo"></p>
<p id="opposedResult" style="display:none;"></p>
<p id="probabilityResult" style="display:none;"></p>

<script>
// Function for regular roll (hides opposed result)
function regularRoll() {
    document.getElementById('opposedResult').style.display = "none";
    document.getElementById('demo').innerHTML = parseAndRoll(document.getElementById('diceInput1').value);
}

// Function to parse and roll based on the chosen system
function parseAndRoll(input) {
    let [dicePart, ...labelParts] = input.split(' ');
    let label = labelParts.join(' ') || "";
    let [numDiceStr, difficultyStr] = dicePart.split('@');
    
    let numDice = parseInt(numDiceStr) || 1;
    let difficulty = difficultyStr ? parseInt(difficultyStr) : 6;
    let exert = /ex/i.test(label);
    if (exert) label = label.replace(/ex/gi, "").trim();
    
    let diceReductionNote = "";
    if (difficulty > 9) {
        let excessDifficulty = difficulty - 9;
        numDice = Math.max(1, numDice - excessDifficulty);
        diceReductionNote = ` (Challenge set to 9 with -${excessDifficulty} Dice)`;
        difficulty = 9;
    }

    // Choose system based on dropdown selection
    let system = document.getElementById("system").value;
    if (system === "exploding") {
        return rollDiceExploding(numDice, difficulty, exert, label, diceReductionNote);
    } else {
        return rollDicePlusTwo(numDice, difficulty, exert, label, diceReductionNote);
    }
}

// Function to roll multiple sets of dice
function printMultipleRolls(times) {
    document.getElementById('opposedResult').style.display = "none"; // Hide opposed result
    let input = document.getElementById('diceInput1').value;
    let results = [];
    for (let i = 0; i < times; i++) {
        results.push(parseAndRoll(input));
    }
    document.getElementById('demo').innerHTML = results.join("<br><br>");
}

// Opposed Roll function with two different inputs
function opposedRoll() {
    const input1 = document.getElementById('diceInput1').value;
    const input2 = document.getElementById('diceInput2').value;

    let roll1 = parseAndRoll(input1);
    let roll2 = parseAndRoll(input2);

    // Extract labels and results from each roll
    let label1 = extractLabel(input1) || "First Roll";
    let label2 = extractLabel(input2) || "Second Roll";
    let result1 = extractResultValue(roll1);
    let result2 = extractResultValue(roll2);
    let difference = Math.abs(result1 - result2);
    
    // Determine the winner and display the result
    let winnerMessage;
    if (result1 > result2) {
        winnerMessage = `${label1} wins by ${difference}`;
    } else if (result2 > result1) {
        winnerMessage = `${label2} wins by ${difference}`;
    } else {
        winnerMessage = "It's a tie!";
    }

    // Display both rolls, the opposed result, and the winner
    document.getElementById('opposedResult').innerHTML = `
        <strong>${label1}:</strong> ${roll1} <br>
        <strong>${label2}:</strong> ${roll2} <br>
        <strong>Difference:</strong> ${difference} <br>
        <strong>${winnerMessage}</strong>
    `;
    document.getElementById('opposedResult').style.display = "block";
}

// Function to extract the numerical result from the roll output
function extractResultValue(rollOutput) {
    let match = rollOutput.match(/Result: (-?\d+)/);
    return match ? parseInt(match[1]) : 0;
}

// Function to extract label from the input command
function extractLabel(input) {
    let parts = input.split(' ');
    return parts.length > 1 ? parts.slice(1).join(' ') : null;
}

// Remove label and keep only dice format for probability calculations
function removeLabel(input) {
    return input.split(' ')[0];
}

// Toggle display of Exact Probability
function toggleExactProbability() {
    const probabilityElement = document.getElementById("probabilityResult");
    document.getElementById('opposedResult').style.display = "none"; // Hide opposed result
    if (probabilityElement.style.display === "none") {
        calculateExactProbability();
        probabilityElement.style.display = "block";
    } else {
        probabilityElement.style.display = "none";
    }
}

// Toggle display of Cumulative Probability
function toggleCumulativeProbability() {
    const probabilityElement = document.getElementById("probabilityResult");
    document.getElementById('opposedResult').style.display = "none"; // Hide opposed result
    if (probabilityElement.style.display === "none") {
        calculateCumulativeProbability();
        probabilityElement.style.display = "block";
    } else {
        probabilityElement.style.display = "none";
    }
}

// Calculate and display exact outcome probabilities with a bar graph
function calculateExactProbability() {
    const input = removeLabel(document.getElementById('diceInput1').value);
    const [numDiceStr, difficultyStr] = input.split('@');
    const numDice = parseInt(numDiceStr) || 1;
    const difficulty = difficultyStr ? parseInt(difficultyStr) : 6;
    const outcomes = simulateExactOutcomeProbabilities(numDice, difficulty);
    displayProbabilityResults(outcomes, "Exact Outcome Probability Distribution (Bell Curve)");
}

// Calculate and display cumulative probability with a bar graph
function calculateCumulativeProbability() {
    const input = removeLabel(document.getElementById('diceInput1').value);
    const [numDiceStr, difficultyStr] = input.split('@');
    const numDice = parseInt(numDiceStr) || 1;
    const difficulty = difficultyStr ? parseInt(difficultyStr) : 6;
    const cumulativeProbabilities = simulateCumulativeOutcomeProbabilities(numDice, difficulty);
    displayProbabilityResults(cumulativeProbabilities, "Cumulative Probability Distribution (At least X Outcome)");
}

// Simulate exact outcome probabilities
function simulateExactOutcomeProbabilities(numDice, difficulty) {
    const trials = 10000;
    const outcomes = {};

    for (let i = 0; i < trials; i++) {
        const outcome = extractResultValue(parseAndRoll(`${numDice}@${difficulty}`));
        outcomes[outcome] = (outcomes[outcome] || 0) + 1;
    }

    for (let outcome in outcomes) {
        outcomes[outcome] = (outcomes[outcome] / trials * 100).toFixed(2);
    }
    return outcomes;
}

// Simulate cumulative probabilities
function simulateCumulativeOutcomeProbabilities(numDice, difficulty) {
    const trials = 10000;
    const cumulativeCounts = {};

    for (let i = 0; i < trials; i++) {
        const outcome = extractResultValue(parseAndRoll(`${numDice}@${difficulty}`));
        for (let target = outcome; target >= -5; target--) {
            cumulativeCounts[target] = (cumulativeCounts[target] || 0) + 1;
        }
    }

    for (let target in cumulativeCounts) {
        cumulativeCounts[target] = (cumulativeCounts[target] / trials * 100).toFixed(2);
    }
    return cumulativeCounts;
}

// Display probability results with bar graphs
function displayProbabilityResults(probabilities, title) {
    let result = `<strong>${title}:</strong><br>`;
    const sortedKeys = Object.keys(probabilities).map(Number).sort((a, b) => a - b);
    for (const key of sortedKeys) {
        const percentage = probabilities[key];
        result += `<div style="display: flex; align-items: center;">
                        <span style="width: 30px; text-align: right;">${key}:</span> 
                        <div style="background-color: #1e90ff; height: 10px; width: ${percentage * 3}px; margin-left: 10px;"></div>
                        <span style="margin-left: 10px;">${percentage}%</span>
                   </div>`;
    }
    document.getElementById("probabilityResult").innerHTML = result;
}

// Exploding system: roll dice with exploding 10s
function rollDiceExploding(numDice, floor, exert, label, diceReductionNote) {
    let results = [];
    let tally = 0;

    for (let i = 0; i < numDice; i++) {
        let roll = Math.floor(Math.random() * 10) + 1;
        let rollDisplay = roll;

        if (roll >= floor && roll < 10) {
            tally += 1;
        } else if (roll === 10) {
            tally += 1;
            let extraRoll = Math.floor(Math.random() * 10) + 1;
            rollDisplay += `(${extraRoll})`; // Show single explosion
            if (extraRoll >= floor) {
                tally += 1;
            }
        } else if (roll === 1) {
            tally -= 1;
        }
        results.push(rollDisplay);
    }

    if (exert) {
        tally += 1;
        label += " (Exerted)";
    }

    // Format the output with the label on top
    return `${label ? `<strong>${label}</strong><br>` : ''}Rolls: ${results.join(", ")} <br> Challenge: ${floor}${diceReductionNote} <br> Result: ${tally}`;
}

// +2 system: each roll of 10 adds +2 directly
function rollDicePlusTwo(numDice, floor, exert, label, diceReductionNote) {
    let results = [];
    let tally = 0;

    for (let i = 0; i < numDice; i++) {
        let roll = Math.floor(Math.random() * 10) + 1;
        let rollDisplay = roll;

        if (roll >= floor && roll < 10) {
            tally += 1;
        } else if (roll === 10) {
            tally += 2; // Each 10 adds +2 in the +2 system
        } else if (roll === 1) {
            tally -= 1;
        }
        results.push(rollDisplay);
    }

    if (exert) {
        tally += 1;
        label += " (Exerted)";
    }

    // Format the output with the label on top
    return `${label ? `<strong>${label}</strong><br>` : ''}Rolls: ${results.join(", ")} <br> Challenge: ${floor}${diceReductionNote} <br> Result: ${tally}`;
}
</script>

</body>
</html>
